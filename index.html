<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>嶼海紀行</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --milk-tea-primary: #4E342E;
      --milk-tea-secondary: #D8C4B6;
      --milk-tea-accent: #A68A71;
      --milk-tea-bg: #FDFBF7;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: var(--milk-tea-bg);
      color: var(--milk-tea-primary);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    .serif { font-family: 'Noto Serif TC', serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass-effect {
      background: rgba(253, 251, 247, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    
    .tab-active {
      background-color: var(--milk-tea-secondary);
      color: white;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    input, textarea, select { outline: none; border: 1px solid #F5EBE0; border-radius: 12px; padding: 10px 14px; background: #FDFBF7; width: 100%; font-size: 14px; color: #4E342E; }
    input:focus, textarea:focus, select:focus { border-color: var(--milk-tea-secondary); box-shadow: 0 0 0 2px rgba(216, 196, 182, 0.2); }
    
    .checkbox-custom { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #D8C4B6; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; }
    .checkbox-custom.checked { background-color: #D8C4B6; }
    .checkbox-custom.checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 12px; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(78, 52, 46, 0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
  </style>

  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import { 
      ClipboardCheck, Map as MapIcon, Plane, Bed, Sparkles, Plus,
      Compass, Wallet, X, Trash2, Clock, Star, Waves, Edit2,
      Calendar, MapPin, ExternalLink, Train, ArrowRight, ChevronRight,
      Check, Utensils, Camera, ShoppingBag, Info, Luggage, Save, DollarSign, RefreshCw, Anchor, LifeBuoy, Search, Bus
    } from 'lucide-react';

    // Global Constants
    const USD_TO_TWD = 32.5;
    const MYR_TO_TWD = 7.5;
    const getGoogleMapsUrl = (name) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;

    const RESORT_ACTIVITY_GROUPS = [
      {
        id: 'diving',
        category: '專業潛水 (Diving)',
        items: [
          { name: '1 Single Boat Dive', price: 65, detail: '僅含氣瓶與配重 (Tanks & Weights ONLY)' },
          { name: '1 Single Boat Dive (Full Set)', price: 89, detail: '包含 BCD、呼吸器、電腦錶、防寒衣全套裝備' },
          { name: '3 Dive Package (Full Set)', price: 260, detail: '3 次船潛優惠套裝，含全套裝備' },
          { name: '5 Dive Package (Full Set)', price: 419, detail: '5 次船潛優惠套裝，含全套裝備' },
          { name: '10 Dive Package (Full Set)', price: 750, detail: '10 次船潛優惠套裝，含全套裝備' },
          { name: 'Orientation Dive', price: 0, detail: '氣瓶檢驗潛水：按法規少於 30 支或 3 個月無紀錄者必備' }
        ]
      },
      {
        id: 'courses',
        category: '證照課程 (PADI Courses)',
        items: [
          { name: 'PADI Scuba Refresh', price: 105, detail: '水下技巧複習與 1 次教練陪同船潛' },
          { name: 'PADI Discover Scuba (DSD)', price: 140, detail: '初學者體驗潛水（含泳池實習與 1 次船潛）' },
          { name: 'Discover Scuba / Training Dive', price: 85, detail: '完成體驗潛水（DSD）後之加購船潛行程' },
          { name: 'PADI Scuba Diver (SD)', price: 390, detail: '包含 2 次船潛與 PADI 水肺潛水員證照' },
          { name: 'PADI Open Water Diver (OWD)', price: 650, detail: '初階證照課程，包含 4 次船潛與國際證照' },
          { name: 'PADI Advanced Open Water (AOW)', price: 550, detail: '進階證照課程，包含 5 次船潛與國際證照' }
        ]
      },
      {
        id: 'watersports',
        category: '水上活動 (Water Sports)',
        items: [
          { name: 'Windsurfing Lesson', price: 70, detail: '專業風帆衝浪教學課程（60 分鐘）' },
          { name: 'Jetski Rental 15m', price: 65, detail: '噴射水上摩托車租賃（15 分鐘）' },
          { name: 'Jetski Rental 30m', price: 110, detail: '噴射水上摩托車租賃（30 分鐘）' },
          { name: 'Wakeboard Lesson', price: 55, detail: '寬板/水上滑板教學課程（30 分鐘）' },
          { name: 'Fun Tube Ride', price: 25, detail: '充氣拖曳圈/香蕉船刺激體驗（15 分鐘/每人）' },
          { name: 'Kayak', price: 0, detail: '獨木舟：房客可享免費租借使用' },
          { name: 'SUP Stand up paddle board', price: 0, detail: '立槳衝浪板：房客可享免費租借使用' }
        ]
      },
      {
        id: 'excursions',
        category: '精選出海行程 (Excursions)',
        items: [
          { name: 'Snorkeling Lesson', price: 20, detail: '浮潛基礎教學與技巧指導（30 分鐘）' },
          { name: 'Snorkeling Trip', price: 60, detail: '90 分鐘專業浮潛出海行程（含完整裝備）' },
          { name: 'Dolphin Adventure', price: 60, detail: '90 分鐘尋找野生海豚蹤影冒險之旅' },
          { name: 'Line Fishing Trip', price: 70, detail: '手線海釣行程，體驗馬爾地夫傳統捕魚' },
          { name: 'Sunset Fishing', price: 70, detail: '浪漫黃昏海釣，享受夕陽與傳統海釣樂趣' },
          { name: 'Sand Bank Trip', price: 100, detail: '夢幻無人沙洲登島行程，極致度假攝影（180 分鐘）' }
        ]
      }
    ];

    const INITIAL_PREP = [
      { id: 'p1', category: '重要文件', item: '護照正本 (效期6個月以上)', note: '建議拍照存手機雲端備份', checked: false },
      { id: 'p2', category: '重要文件', item: '馬爾地夫 IMUGA 申報', note: '抵達前96小時內填寫', checked: false },
      { id: 'p3', category: '重要文件', item: '馬來西亞 MDAC 電子卡', note: '抵達前3天內填寫', checked: false },
      { id: 'p4', category: '重要文件', item: '旅遊行程表/機票/飯店憑證', note: '紙本備份', checked: false },
      { id: 'p5', category: '重要文件', item: '海外旅遊保險單', note: '包含醫療與班機不便險', checked: false },
      { id: 'p6', category: '重要文件', item: '外幣現金 (美金/令吉)', note: '美金需2009年後新鈔', checked: false },
      { id: 'p7', category: '電子電器', item: '萬用轉接頭 (英式三孔)', note: '馬爾地夫與馬來西亞通用', checked: false },
      { id: 'p8', category: '電子電器', item: '行動電源 (10000mAh+)', note: '出海行程電力備援', checked: false },
      { id: 'p10', category: '電子電器', item: 'GoPro 或 防水相機', note: '水下攝影靈魂', checked: false },
      { id: 'p11', category: '衣物穿搭', item: '泳裝/比基尼 (2-3套)', note: '方便換洗', checked: false },
      { id: 'p12', category: '衣物穿搭', item: '水母衣 (長袖防磨衣)', note: '浮潛防曬防刮傷', checked: false },
      { id: 'p13', category: '衣物穿搭', item: '遮陽帽/墨鏡', note: '海邊強光必備', checked: false },
      { id: 'p16', category: '個人用品', item: '海洋友善防曬油', note: 'SPF50+，不傷珊瑚', checked: false },
      { id: 'p17', category: '個人用品', item: '蘆薈修護凝膠', note: '曬後舒緩必備', checked: false },
      { id: 'p18', category: '個人用品', item: '浮潛三寶 (面鏡/呼吸管)', note: '衛生考量建議自備', checked: false },
      { id: 'p19', category: '個人用品', item: '防水袋 (10-20L)', note: '出海保護隨身物品', checked: false },
      { id: 'p21', category: '常備藥品', item: '暈船藥 (強力型)', note: '馬代快艇/小飛機必備', checked: false },
      { id: 'p23', category: '常備藥品', item: '腸胃藥/止瀉藥', note: '預防水土不服', checked: false },
    ];

    const INITIAL_ITINERARY = [
      { date: '1/23', title: '吉隆坡孟沙', activities: [{ id: '1', time: '10:25', title: '高鐵左營 -> 桃園', loc: '高鐵桃園站', note: '12:18 抵達桃園' }, { id: '2', time: '15:10', title: 'MH367 起飛', loc: '桃園機場 T1', note: '20:05 抵達 KUL' }, { id: '3', time: '21:30', title: '飯店 Check-in', loc: 'Holiday Inn Bangsar', note: '吉隆坡第一晚' }] },
      { 
        date: '1/24', 
        title: '精選一日遊', 
        activities: [
          { id: '401', time: '10:00', title: '谷中城 MaxMoney', loc: 'MaxMoney Mid Valley', note: '換匯首選' },
          { id: '402', time: '11:00', title: '谷中城華陽茶室', loc: 'Mid Valley Oriental Kopi', note: '必吃波羅包' },
          { id: '403', time: '12:30', title: '谷中城採購', loc: 'Mid Valley Megamall', note: '採買伴手禮' },
          { id: '404', time: '14:00', title: 'Philo headspa', loc: 'Philo Hair & Head Spa', note: '放鬆體驗' },
          { id: '405', time: '16:30', title: 'Village Park Restaurant 炸雞椰漿飯', loc: 'Uptown Damansara', note: '炸雞必吃' },
          { id: '406', time: '18:00', title: '鬼仔巷', loc: 'Kwai Chai Hong', note: '文化藝術區' },
          { id: '407', time: '19:00', title: 'REXKL書局', loc: 'BookXcess at REXKL', note: '特色書局' },
          { id: '408', time: '20:00', title: '雙子塔', loc: 'Petronas Twin Towers', note: '夜間攝影' },
          { id: '409', time: '21:00', title: '籠的傳人餐廳或三美肉骨茶', loc: 'Pavilion KL / City', note: '晚餐時刻' },
          { id: '410', time: '22:00', title: '柏威年廣場逛街', loc: 'Pavilion Kuala Lumpur', note: '市中心百貨' },
          { id: '411', time: '23:00', title: '回飯店', loc: 'Holiday Inn Bangsar', note: '休整休息' }
        ] 
      },
      { date: '1/25', title: '飛向美居度假村', isMaldives: true, activities: [{ id: '7', time: '09:40', title: 'MH485 飛馬累', loc: 'KLIA T1', note: '11:00 抵達' }, { id: '8', time: '16:00', title: '入住美居度假村', loc: 'Mercure Maldives Kooddoo', note: '全包式度假開始' }] },
      { date: '1/26', title: '深海探索', isMaldives: true, activities: [{ id: '261', time: '09:00', title: '晨間潛水課程', loc: 'Dive Center', note: 'PADI 課程進度' }] },
      { date: '1/27', title: '船潛冒險', isMaldives: true, activities: [{ id: '271', time: '08:30', title: '環礁船潛', loc: 'Kooddoo Jetty', note: '探索更遠的潛點' }] },
      { date: '1/28', title: '水下攝影', isMaldives: true, activities: [{ id: '281', time: '10:00', title: '珊瑚礁浮潛', loc: 'House Reef', note: '紀錄豐富生態' }] },
      { date: '1/29', title: '放鬆時光', isMaldives: true, activities: [{ id: '291', time: '11:00', title: '享受渡假村設施', loc: 'Pool Bar', note: '全包式餐飲服務' }, { id: '301', time: '14:00', title: '搭船前往居民島', loc: 'Hulhumale', note: '入住 h78 飯店' }] },
      { date: '1/30', title: '回程吉隆坡：入住 Umi', activities: [{ id: '302', time: '19:45', title: '飛抵吉隆坡', loc: 'KLIA T1', note: 'MH484 抵達' }, { id: '312', time: '21:30', title: '入住 Umi 民宿', loc: 'Umi SplashMania homestay', note: '溫馨休息空間' }] },
      { date: '1/31', title: '平安賦歸', activities: [{ id: '211', time: '09:20', title: 'MH366 起飛', loc: 'KLIA T1', note: '14:10 抵達 TPE' }, { id: '212', time: '16:34', title: '高鐵桃園 -> 左營', loc: '高鐵桃園站', note: '18:25 抵達左營' }] }
    ];

    const INITIAL_TRANSPORTS = [
      { localId: 't1', date: '01/23', id: '高鐵 0818 次', from: '左營', to: '桃園', depTime: '10:25', arrTime: '12:18', type: 'Train' },
      { localId: 't2', date: '01/23', id: 'MH 367', from: 'TPE', to: 'KUL', depTime: '15:10', arrTime: '20:05', type: 'Plane' },
      { localId: 't3', date: '01/25', id: 'MH 485', from: 'KUL', to: 'MLE', depTime: '09:40', arrTime: '11:00', type: 'Plane' },
      { localId: 't4', date: '01/30', id: 'MH 484', from: 'MLE', to: 'KUL', depTime: '12:00', arrTime: '19:45', type: 'Plane' },
      { localId: 't5', date: '01/31', id: 'MH 366', from: 'KUL', to: 'TPE', depTime: '09:20', arrTime: '14:10', type: 'Plane' },
      { localId: 't6', date: '01/31', id: '高鐵 0841 次', from: '桃園', to: '左營', depTime: '16:34', arrTime: '18:25', type: 'Train' }
    ];

    const REC_POOLS = [
      [
        { category: '吉隆坡精選 KL Selection', location: 'KL', items: [
          { name: 'Village Park Restaurant', desc: '吉隆坡最好吃的椰漿飯，炸雞與醬汁完美結合。' },
          { name: 'Petronas Twin Towers', desc: '最具代表性的地標夜景，震撼力十足。' },
          { name: 'SplashMania Waterpark', desc: '吉隆坡近郊最新水上樂園，設施豐富刺激。' }
        ]},
        { category: '居民島探險 Hulhumale', location: 'MV', items: [
          { name: 'Hulhumale Beach', desc: '夕陽極美的公共沙灘，看在地人生活節奏。' },
          { name: 'h78 Maldives Terrace', desc: '飯店頂樓餐廳，俯瞰機場島海景。' }
        ]}
      ],
      [
        { category: '吉隆坡文化 KL Culture', location: 'KL', items: [
          { name: 'Batu Caves', desc: '黑風洞，壯觀的石灰岩洞穴與彩色階梯。' },
          { name: 'Jalan Alor', desc: '亞羅街夜市，體驗在地大排檔美食文化。' },
          { name: 'Thean Hou Temple', desc: '天后宮，融合現代與傳統的華人廟宇，俯瞰市景。' }
        ]},
        { category: '馬爾地夫休閒 Chill MV', location: 'MV', items: [
          { name: 'Local Market', desc: '體驗馬爾地夫當地市集，感受熱帶水果與香料。' },
          { name: 'Central Park', desc: 'Hulhumale 中央公園，綠意盎然的放鬆去處。' }
        ]}
      ]
    ];

    const App = () => {
      const [activeTab, setActiveTab] = useState('ITINERARY');
      const [itinerary, setItinerary] = useState(() => JSON.parse(localStorage.getItem('trip_itinerary_v50')) || INITIAL_ITINERARY);
      const [prepList, setPrepList] = useState(() => JSON.parse(localStorage.getItem('trip_prep_v50')) || INITIAL_PREP);
      const [transports, setTransports] = useState(() => JSON.parse(localStorage.getItem('trip_transport_v50')) || INITIAL_TRANSPORTS);
      const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem('trip_expenses_v50')) || []);

      useEffect(() => localStorage.setItem('trip_itinerary_v50', JSON.stringify(itinerary)), [itinerary]);
      useEffect(() => localStorage.setItem('trip_prep_v50', JSON.stringify(prepList)), [prepList]);
      useEffect(() => localStorage.setItem('trip_transport_v50', JSON.stringify(transports)), [transports]);
      useEffect(() => localStorage.setItem('trip_expenses_v50', JSON.stringify(expenses)), [expenses]);

      const renderContent = () => {
        switch (activeTab) {
          case 'PREPARATION': return <PreparationView prepList={prepList} setPrepList={setPrepList} />;
          case 'ITINERARY': return <ItineraryView itinerary={itinerary} setItinerary={setItinerary} />;
          case 'TRANSPORT': return <TransportView transports={transports} setTransports={setTransports} />;
          case 'ACCOMMODATION': return <AccommodationView />;
          case 'RECOMMENDATION': return <RecommendationView />;
          case 'EXPENSE': return <ExpenseView expenses={expenses} setExpenses={setExpenses} />;
          default: return <ItineraryView itinerary={itinerary} setItinerary={setItinerary} />;
        }
      };

      return (
        <div className="min-h-screen flex flex-col pb-safe">
          <header className="fixed top-0 left-0 right-0 z-40 glass-effect border-b border-[#F5EBE0] py-4 pt-safe">
            <div className="max-w-xl mx-auto px-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-[#D8C4B6] rounded-2xl flex items-center justify-center text-white shadow-md"><Compass size={20} /></div>
                <div>
                  <h1 className="font-bold text-lg serif text-[#4E342E]">嶼海紀行</h1>
                  <p className="text-[9px] font-black text-[#A68A71] uppercase tracking-[0.3em]">Azure Reverie</p>
                </div>
              </div>
            </div>
          </header>
          <main className="flex-grow pt-24 pb-32 max-w-xl mx-auto w-full px-4">{renderContent()}</main>
          <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[94%] max-w-lg z-50">
            <div className="glass-effect rounded-[2.5rem] shadow-2xl border border-[#F5EBE0]/60 p-1.5 flex justify-between items-center">
              {[
                { id: 'PREPARATION', icon: ClipboardCheck, label: '準備' },
                { id: 'ITINERARY', icon: MapIcon, label: '行程' },
                { id: 'TRANSPORT', icon: Plane, label: '交通' },
                { id: 'ACCOMMODATION', icon: Bed, label: '住宿' },
                { id: 'RECOMMENDATION', icon: Sparkles, label: '推薦' },
                { id: 'EXPENSE', icon: Wallet, label: '換算' }
              ].map(item => (
                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center py-3 rounded-[1.8rem] transition-all flex-1 ${activeTab === item.id ? 'tab-active scale-105' : 'text-[#A68A71]'}`}>
                  <item.icon size={20} /><span className={`text-[10px] mt-1 font-bold ${activeTab === item.id ? 'block' : 'hidden'}`}>{item.label}</span>
                </button>
              ))}
            </div>
          </nav>
        </div>
      );
    };

    function PreparationView({ prepList, setPrepList }) {
      const categories = ['重要文件', '電子電器', '衣物穿搭', '個人用品', '常備藥品'];
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [newItem, setNewItem] = useState({ item: '', category: '重要文件', note: '' });
      const [editingId, setEditingId] = useState(null);

      const handleSaveItem = () => {
        if (!newItem.item.trim()) return;
        if (editingId) {
          setPrepList(prepList.map(p => p.id === editingId ? { ...p, ...newItem } : p));
        } else {
          setPrepList([...prepList, { ...newItem, id: 'custom-' + Date.now(), checked: false }]);
        }
        setIsModalOpen(false);
        setNewItem({ item: '', category: '重要文件', note: '' });
        setEditingId(null);
      };

      const handleEdit = (item) => {
        setNewItem({ item: item.item, category: item.category, note: item.note });
        setEditingId(item.id);
        setIsModalOpen(true);
      };

      const handleDelete = (id) => {
        if (confirm('確定要刪除此項目嗎？')) {
          setPrepList(prepList.filter(p => p.id !== id));
        }
      };

      return (
        <div className="fade-in space-y-6">
          <div className="flex justify-between items-center px-2">
            <h2 className="text-3xl font-bold serif text-[#4E342E]">準備清單</h2>
            <button onClick={() => { setEditingId(null); setNewItem({ item: '', category: '重要文件', note: '' }); setIsModalOpen(true); }} className="w-10 h-10 bg-[#4E342E] text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all"><Plus size={20} /></button>
          </div>
          <div className="space-y-8 pb-10">
            {categories.map(cat => (
              <div key={cat} className="space-y-3">
                <h3 className="text-[10px] font-black text-[#A68A71] uppercase tracking-[0.2em] px-2">{cat}</h3>
                <div className="grid gap-2">
                  {prepList.filter(p => p.category === cat).map(p => (
                    <div key={p.id} className="bg-white p-4 rounded-2xl border border-[#F5EBE0] flex items-center gap-4 shadow-sm hover:border-[#D8C4B6] transition-all group">
                      <div className={`checkbox-custom flex-shrink-0 ${p.checked ? 'checked' : ''}`} onClick={() => setPrepList(prepList.map(item => item.id === p.id ? {...item, checked: !item.checked} : item))} />
                      <div className={`flex-1 ${p.checked ? 'opacity-40' : ''}`}>
                        <div className={`font-bold text-sm ${p.checked ? 'line-through' : ''}`}>{p.item}</div>
                        <div className="text-[10px] text-[#A68A71] italic">{p.note}</div>
                      </div>
                      <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onClick={(e) => { e.stopPropagation(); handleEdit(p); }} className="text-[#A68A71] hover:text-[#4E342E]"><Edit2 size={16} /></button>
                        <button onClick={(e) => { e.stopPropagation(); handleDelete(p.id); }} className="text-[#A68A71] hover:text-red-500"><Trash2 size={16} /></button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-bold serif text-[#4E342E]">{editingId ? '編輯準備項目' : '新增準備項目'}</h3>
                <div className="space-y-3">
                  <div>
                    <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">項目名稱</label>
                    <input type="text" value={newItem.item} onChange={e => setNewItem({...newItem, item: e.target.value})} placeholder="例如：相機電池" />
                  </div>
                  <div>
                    <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">分類</label>
                    <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                  </div>
                  <div>
                    <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">備註</label>
                    <input type="text" value={newItem.note} onChange={e => setNewItem({...newItem, note: e.target.value})} placeholder="選填備註" />
                  </div>
                </div>
                <div className="flex gap-3 pt-4">
                  <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 font-bold text-[#A68A71] rounded-2xl border border-[#F5EBE0]">取消</button>
                  <button onClick={handleSaveItem} className="flex-1 py-3 font-bold bg-[#D8C4B6] text-white rounded-2xl shadow-md">{editingId ? '更新項目' : '儲存項目'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ItineraryView({ itinerary, setItinerary }) {
      const [dayIdx, setDayIdx] = useState(0);
      const [searchTerm, setSearchTerm] = useState('');
      const [showSearch, setShowSearch] = useState(false);
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [showOthers, setShowOthers] = useState(false);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [newAct, setNewAct] = useState({ time: '09:00', title: '', loc: '', note: '' });
      const [editingActId, setEditingActId] = useState(null);
      const day = itinerary[dayIdx];

      const timeOptions = useMemo(() => {
        const options = [];
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 30) {
            options.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
          }
        }
        return options;
      }, []);

      const handleSaveActivity = () => {
        if (!newAct.title.trim()) return;
        const updatedItinerary = [...itinerary];
        if (editingActId) {
          updatedItinerary[dayIdx].activities = updatedItinerary[dayIdx].activities.map(a => a.id === editingActId ? { ...a, ...newAct } : a);
        } else {
          updatedItinerary[dayIdx].activities.push({ ...newAct, id: 'act-' + Date.now() });
        }
        updatedItinerary[dayIdx].activities.sort((a, b) => a.time.localeCompare(b.time));
        setItinerary(updatedItinerary);
        setIsModalOpen(false);
        setNewAct({ time: '09:00', title: '', loc: '', note: '' });
        setEditingActId(null);
      };

      const handleEditActivity = (act) => {
        setNewAct({ time: act.time, title: act.title, loc: act.loc, note: act.note });
        setEditingActId(act.id);
        setIsModalOpen(true);
      };

      const handleDeleteActivity = (id) => {
        if (confirm('確定要刪除此行程嗎？')) {
          const updatedItinerary = [...itinerary];
          updatedItinerary[dayIdx].activities = updatedItinerary[dayIdx].activities.filter(a => a.id !== id);
          setItinerary(updatedItinerary);
        }
      };

      const handleDeleteCurrent = () => {
         if (confirm('確定要刪除此行程嗎？')) {
          const updatedItinerary = [...itinerary];
          updatedItinerary[dayIdx].activities = updatedItinerary[dayIdx].activities.filter(a => a.id !== editingActId);
          setItinerary(updatedItinerary);
          setIsModalOpen(false);
          setEditingActId(null);
        }
      };

      const handleRefresh = () => {
        setIsRefreshing(true);
        setShowOthers(true); 
        setTimeout(() => setIsRefreshing(false), 800);
      };

      const displayGroups = useMemo(() => {
        const groupsToProcess = (showOthers || searchTerm) ? RESORT_ACTIVITY_GROUPS : [RESORT_ACTIVITY_GROUPS[0]];
        return groupsToProcess.map(group => {
          let items = group.items;
          if (searchTerm) {
            items = items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()) || item.detail.toLowerCase().includes(searchTerm.toLowerCase()));
          } else {
            items = items.slice(0, 6);
          }
          return { ...group, items };
        }).filter(group => group.items.length > 0);
      }, [searchTerm, showOthers]);

      return (
        <div className="fade-in space-y-6">
          <div className="flex overflow-x-auto gap-3 pb-2 no-scrollbar snap-x">
            {itinerary.map((d, i) => (
              <button key={i} onClick={() => setDayIdx(i)} className={`flex-shrink-0 w-12 h-16 rounded-2xl flex flex-col items-center justify-center border transition-all ${dayIdx === i ? 'bg-[#4E342E] text-white shadow-lg' : 'bg-white text-[#A68A71] border-[#F5EBE0]'}`}>
                <span className="text-[8px] font-black uppercase opacity-60">{d.date.includes('/') ? 'Jan' : 'Feb'}</span><span className="text-lg font-black mt-1">{d.date.includes('/') ? d.date.split('/')[1] : d.date.split('.')[1]}</span>
              </button>
            ))}
          </div>
          <div className="bg-white p-7 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm mb-6 relative">
            <div className="flex justify-between items-start mb-6">
              <h2 className="text-2xl font-bold text-[#4E342E] serif leading-tight">Day 0{dayIdx+1} {day.title}</h2>
              <button onClick={() => { setEditingActId(null); setNewAct({ time: '09:00', title: '', loc: '', note: '' }); setIsModalOpen(true); }} className="w-9 h-9 bg-[#FDFBF7] border border-[#F5EBE0] text-[#A68A71] rounded-xl flex items-center justify-center active:scale-95 transition-all shadow-sm"><Plus size={18} /></button>
            </div>
            <div className="space-y-8 relative ml-1">
              <div className="absolute left-[17px] top-3 bottom-3 w-[1px] bg-[#F5EBE0]" />
              {day.activities.map(act => (
                <div key={act.id} className="flex gap-5 relative z-10 group">
                  <div className="w-9 h-9 rounded-xl border-2 border-[#F5EBE0] bg-white flex items-center justify-center text-[#4E342E] shrink-0"><Clock size={16} /></div>
                  <div className="flex-1 cursor-pointer" onClick={() => window.open(getGoogleMapsUrl(act.loc || act.title), '_blank')}>
                    <span className="text-[10px] font-black text-[#D8C4B6]">{act.time}</span>
                    <h4 className="font-bold text-base text-[#4E342E]">{act.title}</h4>
                    {act.loc && <div className="text-[10px] text-[#A68A71] flex items-center gap-1 mt-1 font-bold"><MapPin size={10} /> {act.loc}</div>}
                    {act.note && <p className="text-[10px] text-[#A68A71] italic mt-1">{act.note}</p>}
                  </div>
                  <div className="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity justify-center">
                    <button onClick={(e) => { e.stopPropagation(); handleEditActivity(act); }} className="text-[#A68A71] hover:text-[#4E342E]"><Edit2 size={16} /></button>
                    <button onClick={(e) => { e.stopPropagation(); handleDeleteActivity(act.id); }} className="text-[#A68A71] hover:text-red-500"><Trash2 size={16} /></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
          {day.isMaldives && (
            <div className="bg-[#4E342E] p-8 rounded-[2.5rem] text-white shadow-xl mb-6 fade-in">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold serif flex items-center gap-3"><Waves className="text-[#D8C4B6]" /> 自費表 (Activity Pricing)</h3>
                <div className="flex gap-2">
                  <button onClick={() => setShowSearch(!showSearch)} className="w-9 h-9 bg-white/10 rounded-xl flex items-center justify-center text-[#D8C4B6] hover:bg-white/20 transition-all"><Search size={18} /></button>
                  <button onClick={handleRefresh} className={`w-9 h-9 bg-white/10 rounded-xl flex items-center justify-center text-[#D8C4B6] hover:bg-white/20 transition-all ${isRefreshing ? 'animate-spin' : ''}`}><RefreshCw size={18} /></button>
                </div>
              </div>
              {showSearch && <div className="mb-6 fade-in"><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="搜尋潛水、課程、水上活動..." className="w-full bg-white/10 border-white/10 text-white placeholder:text-white/30 focus:border-[#D8C4B6] focus:bg-white/20" autoFocus /></div>}
              <div className="space-y-10">
                {displayGroups.map((group) => (
                  <div key={group.id} className="space-y-4">
                    <h4 className="text-[10px] font-black text-[#D8C4B6] uppercase tracking-[0.2em] opacity-60 px-1">{group.category}</h4>
                    <div className="grid gap-4">
                      {group.items.map((item, i) => (
                        <div key={i} className="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/5 hover:border-white/20 transition-all">
                          <div className="flex-1 pr-4"><h4 className="font-bold text-sm text-[#D8C4B6]">{item.name}</h4><p className="text-[9px] text-white/40 mt-0.5">{item.detail}</p></div>
                          <div className="text-right">{item.price > 0 ? <><div className="text-lg font-black text-white">${item.price}</div><div className="text-[9px] font-black text-[#D8C4B6]">≈ NT$ {Math.round(item.price * USD_TO_TWD).toLocaleString()}</div></> : <div className="text-lg font-black text-white">FREE</div>}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-bold serif text-[#4E342E]">{editingActId ? '編輯當日行程' : '新增當日行程'}</h3>
                <div className="space-y-3">
                  <div><label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">時間</label><select value={newAct.time} onChange={e => setNewAct({...newAct, time: e.target.value})}>{timeOptions.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                  <div><label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">標題</label><input type="text" value={newAct.title} onChange={e => setNewAct({...newAct, title: e.target.value})} placeholder="例如：景點參觀" /></div>
                  <div><label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">地點</label><input type="text" value={newAct.loc} onChange={e => setNewAct({...newAct, loc: e.target.value})} placeholder="例如：雙子塔" /></div>
                  <div><label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">備註</label><input type="text" value={newAct.note} onChange={e => setNewAct({...newAct, note: e.target.value})} placeholder="選填備註" /></div>
                </div>
                <div className="space-y-3 pt-2">
                  <div className="flex gap-3">
                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 font-bold text-[#A68A71] rounded-2xl border border-[#F5EBE0]">取消</button>
                    <button onClick={handleSaveActivity} className="flex-1 py-3 font-bold bg-[#D8C4B6] text-white rounded-2xl shadow-md">{editingActId ? '更新行程' : '儲存行程'}</button>
                  </div>
                  {editingActId && (
                    <button 
                      onClick={handleDeleteCurrent}
                      className="w-full py-3 font-bold text-[#ef4444] bg-red-50 rounded-2xl border border-red-100 flex items-center justify-center gap-2 active:scale-95 transition-all"
                    >
                      <Trash2 size={16} />
                      刪除此行程
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function TransportView({ transports, setTransports }) {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [newTransport, setNewTransport] = useState({ id: '', type: 'Plane', date: '01/23', from: '', to: '', depTime: '', arrTime: '' });
      const [editingId, setEditingId] = useState(null);

      const handleSaveTransport = () => {
        if (!newTransport.id.trim() || !newTransport.from.trim() || !newTransport.to.trim()) return;
        
        if (editingId) {
          setTransports(transports.map(t => (t.localId || t.id) === editingId ? { ...newTransport, localId: editingId } : t));
        } else {
          setTransports([...transports, { ...newTransport, localId: 'trans-' + Date.now() }]);
        }
        
        setIsModalOpen(false);
        setNewTransport({ id: '', type: 'Plane', date: '01/23', from: '', to: '', depTime: '', arrTime: '' });
        setEditingId(null);
      };

      const handleEdit = (t) => {
        setNewTransport({ 
          id: t.id, 
          type: t.type, 
          date: t.date, 
          from: t.from, 
          to: t.to, 
          depTime: t.depTime, 
          arrTime: t.arrTime 
        });
        setEditingId(t.localId || t.id);
        setIsModalOpen(true);
      };

      const handleDeleteTransport = (id) => {
        if (confirm('確定要刪除此交通行程嗎？')) {
          setTransports(transports.filter(t => (t.localId || t.id) !== id));
        }
      };
      
      const handleDeleteCurrent = () => {
         if (confirm('確定要刪除此交通行程嗎？')) {
          setTransports(transports.filter(t => (t.localId || t.id) !== editingId));
          setIsModalOpen(false);
          setEditingId(null);
        }
      };

      const getIcon = (type) => {
        switch (type) {
          case 'Train': return <Train size={18} />;
          case 'Bus': return <Bus size={18} />;
          default: return <Plane size={18} />;
        }
      };

      return (
        <div className="fade-in space-y-6">
          <div className="flex justify-between items-center px-2">
            <h2 className="text-3xl font-bold serif text-[#4E342E]">交通資訊</h2>
            <button onClick={() => { setEditingId(null); setNewTransport({ id: '', type: 'Plane', date: '01/23', from: '', to: '', depTime: '', arrTime: '' }); setIsModalOpen(true); }} className="w-10 h-10 bg-[#4E342E] text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all"><Plus size={20} /></button>
          </div>

          {transports.map((t, i) => (
            <div key={t.localId || i} className="bg-white rounded-[2.5rem] border border-[#F5EBE0] p-7 flex flex-col shadow-sm cursor-pointer hover:border-[#D8C4B6] transition-all group relative" onClick={() => window.open(getGoogleMapsUrl(t.to), '_blank')}>
              <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                <button 
                  onClick={(e) => { e.stopPropagation(); handleEdit(t); }} 
                  className="p-2 text-[#A68A71] hover:text-[#4E342E] transition-all"
                >
                  <Edit2 size={18} />
                </button>
                <button 
                  onClick={(e) => { e.stopPropagation(); handleDeleteTransport(t.localId || t.id); }} 
                  className="p-2 text-[#A68A71] hover:text-red-500 transition-all"
                >
                  <Trash2 size={18} />
                </button>
              </div>
              <div className="flex justify-between items-center mb-6">
                 <div><div className="font-black text-lg text-[#4E342E]">{t.id}</div><div className="text-[10px] text-[#A68A71] font-bold uppercase tracking-widest">{t.date}</div></div>
                 <div className="w-10 h-10 bg-[#D8C4B6] rounded-xl flex items-center justify-center text-white">{getIcon(t.type)}</div>
              </div>
              <div className="flex items-center justify-between gap-2 px-2">
                <div className="flex flex-col flex-1 items-start">
                  <div className="font-bold text-base text-[#4E342E] truncate w-full">{t.from}</div>
                  <div className="text-3xl font-black text-[#4E342E] tracking-tighter mt-1">{t.depTime}</div>
                </div>
                <div className="opacity-20 shrink-0 pt-6"><ArrowRight size={24} /></div>
                <div className="flex flex-col flex-1 items-end text-right">
                  <div className="font-bold text-base text-[#4E342E] truncate w-full">{t.to}</div>
                  <div className="text-3xl font-black text-[#4E342E] tracking-tighter mt-1">{t.arrTime}</div>
                </div>
              </div>
            </div>
          ))}

          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-bold serif text-[#4E342E]">{editingId ? '編輯交通資訊' : '新增交通資訊'}</h3>
                <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">車次 / 班機</label>
                      <input type="text" value={newTransport.id} onChange={e => setNewTransport({...newTransport, id: e.target.value})} placeholder="例如：MH367" />
                    </div>
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">類型</label>
                      <select value={newTransport.type} onChange={e => setNewTransport({...newTransport, type: e.target.value})}>
                        <option value="Plane">飛機</option>
                        <option value="Train">高鐵 / 火車</option>
                        <option value="Bus">大眾運輸 / 巴士</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">日期</label>
                    <input type="text" value={newTransport.date} onChange={e => setNewTransport({...newTransport, date: e.target.value})} placeholder="例如：01/23" />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">出發時間</label>
                      <input type="text" value={newTransport.depTime} onChange={e => setNewTransport({...newTransport, depTime: e.target.value})} placeholder="15:10" />
                    </div>
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">抵達時間</label>
                      <input type="text" value={newTransport.arrTime} onChange={e => setNewTransport({...newTransport, arrTime: e.target.value})} placeholder="20:05" />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">出發地</label>
                      <input type="text" value={newTransport.from} onChange={e => setNewTransport({...newTransport, from: e.target.value})} placeholder="TPE" />
                    </div>
                    <div>
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">目的地</label>
                      <input type="text" value={newTransport.to} onChange={e => setNewTransport({...newTransport, to: e.target.value})} placeholder="KUL" />
                    </div>
                  </div>
                </div>
                <div className="space-y-3 pt-2">
                  <div className="flex gap-3">
                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 font-bold text-[#A68A71] rounded-2xl border border-[#F5EBE0]">取消</button>
                    <button onClick={handleSaveTransport} className="flex-1 py-3 font-bold bg-[#D8C4B6] text-white rounded-2xl shadow-md">{editingId ? '更新交通' : '儲存交通'}</button>
                  </div>
                   {editingId && (
                    <button 
                      onClick={handleDeleteCurrent}
                      className="w-full py-3 font-bold text-[#ef4444] bg-red-50 rounded-2xl border border-red-100 flex items-center justify-center gap-2 active:scale-95 transition-all"
                    >
                      <Trash2 size={16} />
                      刪除此行程
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function AccommodationView() {
      const hotels = [
        { nameZh: '吉隆坡孟沙假日酒店', nameEn: 'Holiday Inn Kuala Lumpur Bangsar', date: '1/23-1/25', image: 'https://images.unsplash.com/photo-1520250497591-112f2f40a3f4?auto=format&fit=crop&q=80&w=800', note: '時尚孟沙區，交通非常便利。' },
        { nameZh: '美居馬爾地夫度假村', nameEn: 'Mercure Maldives Kooddoo Resort', date: '1/25-1/29', image: 'https://images.unsplash.com/photo-1514282401047-d79a71a590e8?auto=format&fit=crop&q=80&w=800', note: '全包式水上別墅，潛水者天堂。' },
        { nameZh: '馬爾地夫居民島 h78 飯店', nameEn: 'h78 Maldives', date: '1/29', image: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&q=80&w=800', note: '海濱首選，銜接機場極度便利。' },
        { nameZh: 'Umi SplashMania 溫馨民宿', nameEn: 'Umi SplashMania homestay', date: '1/30, image: 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&q=80&w=800', note: '鄰近 SplashMania 水上樂園，環境溫馨舒適，返台前的絕佳休憩站。' }
      ];
      return (
        <div className="fade-in space-y-8">
          <h2 className="text-3xl font-bold serif text-[#4E342E] px-2">住宿安排</h2>
          {hotels.map((h, i) => (
            <div key={i} className="bg-white rounded-[3rem] overflow-hidden shadow-sm border border-[#F5EBE0]">
              <div className="h-48 overflow-hidden"><img src={h.image} className="w-full h-full object-cover" /></div>
              <div className="p-8">
                <div className="flex justify-between items-start mb-1">
                   <div className="flex-1 pr-4"><h3 className="text-xl font-bold text-[#4E342E] serif leading-tight">{h.nameZh}</h3><p className="text-[10px] text-[#A68A71] font-bold uppercase mt-1 opacity-60">{h.nameEn}</p></div>
                   <button onClick={() => window.open(getGoogleMapsUrl(h.nameEn), '_blank')} className="w-10 h-10 bg-[#4E342E] text-white rounded-xl flex items-center justify-center shadow-lg transition-all"><Compass size={20} /></button>
                </div>
                <div className="text-xs text-[#A68A71] flex items-center gap-2 my-4"><Calendar size={14} /> {h.date}</div>
                <p className="bg-[#FDFBF7] p-4 rounded-2xl border border-[#F5EBE0] text-xs italic text-[#4E342E] leading-relaxed">{h.note}</p>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function RecommendationView() {
      const [filter, setFilter] = useState('ALL');
      const [poolIdx, setPoolIdx] = useState(0);
      const [isRefreshing, setIsRefreshing] = useState(false);

      const currentRecs = REC_POOLS[poolIdx];

      const filteredRecs = useMemo(() => {
        if (filter === 'ALL') return currentRecs;
        return currentRecs.filter(cat => cat.location === filter);
      }, [filter, poolIdx]);

      const handleUpdateRecs = () => {
        setIsRefreshing(true);
        setTimeout(() => {
          setPoolIdx((prev) => (prev + 1) % REC_POOLS.length);
          setIsRefreshing(false);
        }, 500);
      };

      return (
        <div className="fade-in space-y-8">
          <div className="space-y-4 px-2">
             <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold serif text-[#4E342E]">在地推薦</h2>
                <button onClick={handleUpdateRecs} className={`flex items-center gap-2 px-4 py-2 bg-[#D8C4B6] text-white rounded-xl shadow-md active:scale-95 transition-all ${isRefreshing ? 'opacity-80' : ''}`}>
                  <RefreshCw size={16} className={isRefreshing ? 'animate-spin' : ''} />
                  <span className="text-xs font-bold">更換行程</span>
                </button>
             </div>
             <p className="text-xs text-[#A68A71] font-bold uppercase tracking-widest">景點與行程推薦 Attractions & Plans</p>
          </div>

          <div className="bg-white/50 p-1 rounded-xl border border-[#F5EBE0] flex mx-2">
            <button onClick={() => setFilter('KL')} className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${filter === 'KL' ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>吉隆坡</button>
            <button onClick={() => setFilter('MV')} className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${filter === 'MV' ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>居民島</button>
            <button onClick={() => setFilter('ALL')} className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${filter === 'ALL' ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>全部</button>
          </div>

          <div className="space-y-10">
            {filteredRecs.map((cat, idx) => (
              <section key={idx} className="space-y-4 fade-in">
                <h3 className="font-bold text-lg text-[#4E342E] serif flex items-center gap-2 px-2"><Utensils size={18} className="text-[#A68A71]" /> {cat.category}</h3>
                <div className="grid gap-4">
                  {cat.items.map((item, i) => (
                    <div key={i} className="bg-white p-6 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm cursor-pointer hover:border-[#D8C4B6] transition-all" onClick={() => window.open(getGoogleMapsUrl(item.name), '_blank')}>
                      <h4 className="font-bold text-[#4E342E] text-base mb-2">{item.name}</h4><p className="text-xs text-[#A68A71] leading-relaxed italic">{item.desc}</p>
                    </div>
                  ))}
                </div>
              </section>
            ))}
          </div>
        </div>
      );
    }

    function ExpenseView({ expenses, setExpenses }) {
      const [convVal, setConvVal] = useState('');
      const [convMode, setConvMode] = useState('USD');
      
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [newExpense, setNewExpense] = useState({ title: '', currency: 'TWD', amount: '' });
      const [editingId, setEditingId] = useState(null);

      const totalTwd = expenses.reduce((sum, e) => sum + (e.twd || 0), 0);
      const rate = convMode === 'USD' ? USD_TO_TWD : MYR_TO_TWD;
      const result = Math.round((parseFloat(convVal) || 0) * rate);

      const handleSaveExpense = () => {
        if (!newExpense.title.trim() || !newExpense.amount) return;
        
        let twdAmount = 0;
        const amount = parseFloat(newExpense.amount);
        if (newExpense.currency === 'USD') twdAmount = amount * USD_TO_TWD;
        else if (newExpense.currency === 'MYR') twdAmount = amount * MYR_TO_TWD;
        else twdAmount = amount; 

        const expenseData = {
            ...newExpense,
            amount: amount,
            twd: Math.round(twdAmount)
        };

        if (editingId) {
            setExpenses(expenses.map(e => e.id === editingId ? { ...expenseData, id: editingId } : e));
        } else {
            setExpenses([...expenses, { ...expenseData, id: 'exp-' + Date.now() }]);
        }
        
        setIsModalOpen(false);
        setNewExpense({ title: '', currency: 'TWD', amount: '' });
        setEditingId(null);
      };

      const handleDeleteExpense = (id) => {
          if (confirm('確定要刪除此筆支出嗎？')) {
              setExpenses(expenses.filter(e => e.id !== id));
          }
      };

      const handleEdit = (exp) => {
          setNewExpense({ title: exp.title, currency: exp.currency, amount: exp.amount });
          setEditingId(exp.id);
          setIsModalOpen(true);
      };

      return (
        <div className="fade-in space-y-6 pb-20">
          <div className="bg-white p-8 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm space-y-6">
            <h3 className="font-bold text-sm text-[#4E342E] flex items-center gap-2"><DollarSign size={16} className="text-[#D8C4B6]" /> 匯率快速換算</h3>
            <div className="flex bg-[#FDFBF7] p-1.5 rounded-2xl border border-[#F5EBE0] mb-2">
              <button onClick={() => setConvMode('USD')} className={`flex-1 py-2.5 rounded-xl text-xs font-black transition-all ${convMode === 'USD' ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>美金 USD</button>
              <button onClick={() => setConvMode('MYR')} className={`flex-1 py-2.5 rounded-xl text-xs font-black transition-all ${convMode === 'MYR' ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>令吉 MYR</button>
            </div>
            <div className="text-center space-y-3 py-4">
              <div className="text-[10px] font-black text-[#A68A71] uppercase tracking-[0.2em]">1 {convMode} : {rate} TWD</div>
              <input type="number" value={convVal} onChange={e => setConvVal(e.target.value)} placeholder={`輸入 ${convMode} 金額`} className="text-center font-black text-3xl py-2 bg-transparent border-b-2 border-[#F5EBE0] focus:border-[#D8C4B6] w-full" />
              <div className="text-xl font-black text-[#4E342E] mt-4">≈ NT$ {result.toLocaleString()}</div>
            </div>
          </div>
          <div className="bg-[#4E342E] p-8 rounded-[3rem] text-white shadow-2xl flex justify-between items-center">
            <div><p className="text-[10px] font-black opacity-50 uppercase tracking-widest">總支出預估</p><h2 className="text-3xl font-black mt-1">NT$ {totalTwd.toLocaleString()}</h2></div>
            <Wallet size={40} className="opacity-10" />
          </div>
          <div className="flex justify-between items-center px-2">
            <h2 className="text-xl font-bold serif text-[#4E342E]">支出明細</h2>
            <button onClick={() => { setEditingId(null); setNewExpense({ title: '', currency: 'TWD', amount: '' }); setIsModalOpen(true); }} className="w-10 h-10 bg-[#4E342E] text-white rounded-xl flex items-center justify-center shadow-lg transition-all"><Plus size={20} /></button>
          </div>
          <div className="space-y-3">
            {expenses.map(e => (
              <div key={e.id} className="bg-white p-5 rounded-2xl border border-[#F5EBE0] flex justify-between items-center shadow-sm cursor-pointer hover:border-[#D8C4B6] transition-all group relative">
                <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all bg-white pl-2">
                    <button onClick={(ev) => { ev.stopPropagation(); handleEdit(e); }} className="p-2 text-[#A68A71] hover:text-[#4E342E] transition-all"><Edit2 size={16} /></button>
                    <button onClick={(ev) => { ev.stopPropagation(); handleDeleteExpense(e.id); }} className="p-2 text-[#A68A71] hover:text-red-500 transition-all"><Trash2 size={16} /></button>
                </div>
                <div><div className="font-bold text-[#4E342E] text-sm">{e.title}</div><div className="text-[10px] text-[#A68A71] font-bold uppercase">{e.currency} {e.amount}</div></div>
                <div className="text-right font-black text-[#4E342E]">NT$ {e.twd.toLocaleString()}</div>
              </div>
            ))}
          </div>

          {isModalOpen && (
            <div className="modal-overlay" onClick={() => setIsModalOpen(false)}>
              <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-bold serif text-[#4E342E]">{editingId ? '編輯支出' : '新增支出'}</h3>
                <div className="space-y-3">
                  <div>
                    <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">項目名稱</label>
                    <input type="text" value={newExpense.title} onChange={e => setNewExpense({...newExpense, title: e.target.value})} placeholder="例如：晚餐" />
                  </div>
                  <div className="grid grid-cols-3 gap-3">
                    <div className="col-span-1">
                      <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">幣別</label>
                      <select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})}>
                        <option value="TWD">TWD</option>
                        <option value="USD">USD</option>
                        <option value="MYR">MYR</option>
                      </select>
                    </div>
                    <div className="col-span-2">
                        <label className="text-[10px] font-black text-[#A68A71] uppercase ml-2">金額</label>
                        <input type="number" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} placeholder="輸入金額" />
                    </div>
                  </div>
                </div>
                <div className="flex gap-3 pt-4">
                  <button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 font-bold text-[#A68A71] rounded-2xl border border-[#F5EBE0]">取消</button>
                  <button onClick={handleSaveExpense} className="flex-1 py-3 font-bold bg-[#D8C4B6] text-white rounded-2xl shadow-md">{editingId ? '更新' : '儲存'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>