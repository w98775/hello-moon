<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>嶼海紀行</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --milk-tea-primary: #4E342E;
      --milk-tea-secondary: #D8C4B6;
      --milk-tea-accent: #A68A71;
      --milk-tea-bg: #FDFBF7;
    }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: var(--milk-tea-bg);
      color: var(--milk-tea-primary);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }
    .serif { font-family: 'Noto Serif TC', serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass-effect {
      background: rgba(253, 251, 247, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    
    .tab-active {
      background-color: var(--milk-tea-secondary);
      color: white;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    
    input, textarea, select { outline: none; border: 1px solid #F5EBE0; border-radius: 12px; padding: 10px 14px; background: #FDFBF7; width: 100%; font-size: 14px; color: #4E342E; }
    input:focus, textarea:focus, select:focus { border-color: var(--milk-tea-secondary); box-shadow: 0 0 0 2px rgba(216, 196, 182, 0.2); }
    
    .checkbox-custom { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #D8C4B6; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; }
    .checkbox-custom.checked { background-color: #D8C4B6; }
    .checkbox-custom.checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 12px; }

    .floating-action-button {
      position: fixed;
      right: 24px;
      top: 100px;
      z-index: 55;
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background-color: #D8C4B6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(78, 52, 46, 0.2);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .floating-action-button:active {
      transform: scale(0.9) rotate(45deg);
      box-shadow: 0 2px 6px rgba(78, 52, 46, 0.1);
    }
  </style>

  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import { 
      ClipboardCheck, Map as MapIcon, Plane, Bed, Sparkles, Plus,
      Compass, Wallet, X, Trash2, Clock, Star, Waves, Edit2,
      Calendar, MapPin, ExternalLink, Train, ArrowRight, ChevronRight,
      Check, Utensils, Camera, ShoppingBag, Info, Luggage, Save, DollarSign, RefreshCw, Anchor, LifeBuoy, Search
    } from 'lucide-react';

    const USD_TO_TWD = 32.5;
    const MYR_TO_TWD = 7.5;

    // 自費活動數據分組
    const RESORT_ACTIVITY_GROUPS = [
      {
        id: 'teaching',
        category: '潛水教學與課程',
        items: [
          { name: 'PADI Discover Scuba (DSD)', price: 140, detail: '泳池練習 + 1次船潛' },
          { name: 'PADI Scuba Refresh', price: 105, detail: '技巧複習 + 1次船潛' },
          { name: 'Single Boat Dive (Full Set)', price: 89, detail: '包含全套裝備單次船潛' },
          { name: 'PADI Open Water Diver', price: 650, detail: '初階開放水域證照課程' }
        ]
      },
      {
        id: 'packages',
        category: '潛水多日套裝',
        items: [
          { name: '3 Dive Package (Full Set)', price: 260, detail: '3次船潛套裝，含裝備' },
          { name: '5 Dive Package (Full Set)', price: 419, detail: '5次船潛套裝，含裝備' },
          { name: '10 Dive Package (Full Set)', price: 750, detail: '10次船潛套裝，含裝備' },
          { name: 'Night Boat Dive', price: 100, detail: '深度/夜潛專長單次費用' }
        ]
      },
      {
        id: 'watersports',
        category: '水上中心運動',
        items: [
          { name: 'Jetski Rental (30 mins)', price: 110, detail: '水上摩托車 30 分鐘租借' },
          { name: 'Fun Tube Ride (15 mins)', price: 25, detail: '充氣拖曳圈 (每人/每次)' },
          { name: 'Windsurfing Lesson (60m)', price: 70, detail: '風帆衝浪基礎教學' },
          { name: 'GoPro 11 Camera Rental', price: 20, detail: '水下相機租借 60 分鐘' }
        ]
      },
      {
        id: 'excursions',
        category: '精選出海行程',
        items: [
          { name: 'Snorkeling Trip', price: 60, detail: '90 分鐘浮潛出海行程' },
          { name: 'Dolphin Adventure', price: 60, detail: '尋找海豚蹤影 90 分鐘' },
          { name: 'Sunset Fishing', price: 70, detail: '傳統馬代黃昏海釣' },
          { name: 'Sand Bank Trip', price: 100, detail: '夢幻無人沙洲 180 分鐘' }
        ]
      }
    ];

    const INITIAL_PREP = [
      { id: 'p1', category: '重要文件', item: '護照正本 (效期6個月以上)', note: '建議拍照存手機雲端備份', checked: false },
      { id: 'p2', category: '重要文件', item: '馬爾地夫 IMUGA 申報', note: '抵達/離開前96小時內填寫', checked: false },
      { id: 'p3', category: '重要文件', item: '馬來西亞 MDAC 電子卡', note: '抵達前3天內填寫', checked: false },
      { id: 'p4', category: '重要文件', item: '飯店/機票憑證 (電子+紙本)', note: '包含自費行程確認單', checked: false },
      { id: 'p14', category: '重要文件', item: '海外旅遊保險', note: '建議列印保單以備不時之需', checked: false },
      { id: 'p5', category: '電子電器', item: '萬用轉接頭 (英式三孔)', note: '馬爾地夫與馬來西亞皆為英規', checked: false },
      { id: 'p6', category: '電子電器', item: '多孔快充頭 / 延長線', note: '設備多時非常受用', checked: false },
      { id: 'p15', category: '電子電器', item: '行動電源 (10000mAh+)', note: '出海行程長，電力必備', checked: false },
      { id: 'p16', category: '電子電器', item: '防水手機袋 / GoPro', note: '浮潛攝影靈魂工具', checked: false },
      { id: 'p17', category: '衣物穿搭', item: '水母衣 (防磨長袖長褲)', note: '馬代防曬防刮必備', checked: false },
      { id: 'p18', category: '衣物穿搭', item: '泳裝 / 比基尼 (2套以上)', note: '度假村換洗用', checked: false },
      { id: 'p19', category: '衣物穿搭', item: '草帽 / 墨鏡 / 涼鞋', note: '島上穿搭與防曬', checked: false },
      { id: 'p20', category: '衣物穿搭', item: '薄外套 / 飛機裝', note: '機艙與大馬百貨冷氣強', checked: false },
      { id: 'p7', category: '馬爾地夫專屬', item: '海洋友善防曬油', note: '拒絕化學成分，保護珊瑚礁', checked: false },
      { id: 'p9', category: '馬爾地夫專屬', item: '個人浮潛三寶', note: '衛生考量建議自備面鏡呼吸管', checked: false },
      { id: 'p21', category: '馬爾地夫專屬', item: '防水袋 (10-20L)', note: '出海保護手機相機', checked: false },
      { id: 'p10', category: '馬爾地夫專屬', item: '1元美金新鈔 (30-50張)', note: '用於飯店打掃、行李小費', checked: false },
      { id: 'p11', category: '個人藥品', item: '暈船藥 (強力型)', note: '馬代內陸船/快艇必備', checked: false },
      { id: 'p12', category: '個人藥品', item: '腸胃藥 / 止瀉藥', note: '預防環境不適', checked: false },
      { id: 'p22', category: '個人藥品', item: '曬後修復蘆薈膠', note: '曬傷救星', checked: false },
      { id: 'p13', category: '個人藥品', item: '防蚊液 / 止癢藥', note: '島上與大馬市區蚊蟲多', checked: false },
      { id: 'p23', category: '生活用品', item: '濕紙巾 / 手部消毒液', note: '隨時保持衛生', checked: false },
      { id: 'p24', category: '生活用品', item: '摺疊雨傘 / 輕便雨衣', note: '熱帶雷陣雨必備', checked: false },
      { id: 'p25', category: '生活用品', item: 'Grab App 安裝與綁卡', note: '大馬叫車與外送神魂', checked: false },
    ];

    const INITIAL_ITINERARY = [
      { date: '1/23', title: '啟程：吉隆坡孟沙', activities: [{ id: '1', time: '10:25', title: '高鐵左營 -> 桃園', loc: '高鐵左營站', note: '12:18 抵達桃園' }, { id: '2', time: '15:10', title: 'MH367 起飛', loc: '桃園機場 T1', note: '20:05 抵達 KUL' }, { id: '3', time: '21:30', title: '飯店 Check-in', loc: 'Holiday Inn Bangsar', note: '吉隆坡第一晚' }] },
      { 
        date: '1/24', 
        title: '吉隆坡：市中心探索', 
        activities: [
          { id: '41', time: '10:00', title: '谷中城 MaxMoney', loc: 'Mid Valley Megamall', note: '換匯' },
          { id: '42', time: '11:00', title: '谷中城華陽茶室', loc: 'Mid Valley Megamall', note: '早午餐，推薦蛋塔' },
          { id: '45', time: '16:00', title: 'Village Park Restaurant 炸雞椰漿飯', loc: 'Uptown Damansara', note: '吉隆坡最強椰漿飯' },
          { id: '48', time: '19:30', title: '雙子塔', loc: 'Petronas Twin Towers', note: '打卡夜景拍照' }
        ] 
      },
      { date: '1/25', title: '飛向美居渡假村', isMaldives: true, activities: [{ id: '7', time: '09:40', title: 'MH485 飛馬累', loc: 'KLIA T1', note: '11:00 抵達' }, { id: '8', time: '16:00', title: '入住美居渡假村', loc: 'Mercure Maldives Kooddoo', note: '全包式度假村開始' }] },
      { date: '1/26', title: '渡假村休閒', isMaldives: true, activities: [{ id: '9', time: '09:00', title: '別墅外浮潛', loc: 'Villa Reef', note: '水下世界探索' }] },
      { date: '1/27', title: '海洋冒險：鯨鯊', isMaldives: true, activities: [{ id: '11', time: '08:30', title: '鯨鯊追蹤遊 (自費)', loc: 'Gaafu Alifu', note: '220 USD' }] },
      { date: '1/28', title: '環礁之美', isMaldives: true, activities: [{ id: '12', time: '10:00', title: '高空拖曳傘 (自費)', loc: 'Lagoon', note: '160 USD' }] },
      { date: '1/29', title: '居民島停留', activities: [{ id: '14', time: '11:00', title: '搭船前往居民島', loc: 'Hulhumale', note: '入住 h78' }] },
      { date: '1/30', title: '返程：大馬 Umi', activities: [{ id: '16', time: '12:00', title: 'MH484 返大馬', loc: 'Velana Airport', note: '19:45 抵達吉隆坡' }] },
      { date: '1/31', title: '平安賦歸', activities: [{ id: '18', time: '09:20', title: 'MH366 返台', loc: 'KLIA T1', note: '14:10 抵台' }] },
    ];

    const INITIAL_REC = [
      { category: '吉隆坡美食 Gourmet KL', items: [
        { name: 'Village Park Restaurant', rating: 4.6, desc: '被譽為吉隆坡最好吃的椰漿飯，炸雞極致酥脆。' },
        { name: 'Nasi Lemak Wanjo', rating: 4.6, desc: '甘幫峇魯傳統風味，在地人的宵夜與早餐首選。' },
        { name: 'Sun Fong Bak Kut Teh', rating: 4.4, desc: '新峰肉骨茶，老字號藥膳湯頭，推薦點排骨。' }
      ]},
      { category: '吉隆坡景點 Must-See KL', items: [
        { name: 'Petronas Twin Towers', rating: 4.8, desc: '雙子星塔，吉隆坡最具代表性的地標，夜景震撼。' },
        { name: 'Batu Caves', rating: 4.6, desc: '黑風洞，壯觀印度教神廟與彩虹階梯。' },
        { name: 'BookXcess REXKL', rating: 4.5, desc: '迷宮般的特色書店，適合文青拍照打卡。' }
      ]},
      { category: '居民島探險 Hulhumale', items: [
        { name: 'Hulhumale Beach', rating: 4.5, desc: '居民島最長沙灘，夕陽極美，看在地人生活節奏。' },
        { name: 'Family Room Cafe', rating: 4.4, desc: '文青質感咖啡廳，提供高品質咖啡與甜點。' },
        { name: 'Shell Beans', rating: 4.2, desc: '海濱經典餐廳，美式拼盤與海鮮義大利麵非常推薦。' },
        { name: 'Central Park', rating: 4.1, desc: '現代化的城市公園，周邊有許多在地小攤位。' }
      ]}
    ];

    const TIME_OPTIONS = Array.from({ length: 48 }, (_, i) => {
      const h = Math.floor(i / 2).toString().padStart(2, '0');
      const m = (i % 2 === 0 ? '00' : '30');
      return `${h}:${m}`;
    });

    const App = () => {
      const [activeTab, setActiveTab] = useState('ITINERARY');
      const [itinerary, setItinerary] = useState(() => JSON.parse(localStorage.getItem('trip_itinerary_v8')) || INITIAL_ITINERARY);
      const [prepList, setPrepList] = useState(() => JSON.parse(localStorage.getItem('trip_prep_v8')) || INITIAL_PREP);
      const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem('trip_expenses_v8')) || []);

      useEffect(() => localStorage.setItem('trip_itinerary_v8', JSON.stringify(itinerary)), [itinerary]);
      useEffect(() => localStorage.setItem('trip_prep_v8', JSON.stringify(prepList)), [prepList]);
      useEffect(() => localStorage.setItem('trip_expenses_v8', JSON.stringify(expenses)), [expenses]);

      const renderContent = () => {
        switch (activeTab) {
          case 'PREPARATION': return <PreparationView prepList={prepList} setPrepList={setPrepList} />;
          case 'ITINERARY': return <ItineraryView itinerary={itinerary} setItinerary={setItinerary} />;
          case 'TRANSPORT': return <TransportView />;
          case 'ACCOMMODATION': return <AccommodationView />;
          case 'RECOMMENDATION': return <RecommendationView />;
          case 'EXPENSE': return <ExpenseView expenses={expenses} setExpenses={setExpenses} />;
          default: return <ItineraryView itinerary={itinerary} setItinerary={setItinerary} />;
        }
      };

      return (
        <div className="min-h-screen flex flex-col pb-safe">
          <header className="fixed top-0 left-0 right-0 z-40 glass-effect border-b border-[#F5EBE0] py-4 pt-safe">
            <div className="max-w-xl mx-auto px-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-[#D8C4B6] rounded-2xl flex items-center justify-center text-white shadow-md"><Compass size={20} /></div>
                <div><h1 className="font-bold text-lg serif text-[#4E342E]">嶼海紀行</h1><p className="text-[9px] font-black text-[#A68A71] uppercase tracking-[0.2em]">Travel Planner</p></div>
              </div>
            </div>
          </header>
          <main className="flex-grow pt-24 pb-32 max-w-xl mx-auto w-full px-4">{renderContent()}</main>
          <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[94%] max-w-lg z-50">
            <div className="glass-effect rounded-[2.5rem] shadow-2xl border border-[#F5EBE0]/60 p-1.5 flex justify-between items-center">
              {[
                { id: 'PREPARATION', icon: ClipboardCheck, label: '準備' },
                { id: 'ITINERARY', icon: MapIcon, label: '行程' },
                { id: 'TRANSPORT', icon: Plane, label: '交通' },
                { id: 'ACCOMMODATION', icon: Bed, label: '住宿' },
                { id: 'RECOMMENDATION', icon: Sparkles, label: '推薦' },
                { id: 'EXPENSE', icon: Wallet, label: '換算' }
              ].map(item => (
                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center py-3 rounded-[1.8rem] transition-all flex-1 ${activeTab === item.id ? 'tab-active scale-105' : 'text-[#A68A71]'}`}>
                  <item.icon size={20} /><span className={`text-[10px] mt-1 font-bold ${activeTab === item.id ? 'block' : 'hidden'}`}>{item.label}</span>
                </button>
              ))}
            </div>
          </nav>
        </div>
      );
    };

    function PreparationView({ prepList, setPrepList }) {
      const [showModal, setShowModal] = useState(false);
      const [editItem, setEditItem] = useState(null);
      const [formData, setFormData] = useState({ category: '重要文件', item: '', note: '' });

      const handleSave = () => {
        if (!formData.item) return;
        if (editItem) setPrepList(prepList.map(p => p.id === editItem.id ? { ...p, ...formData } : p));
        else setPrepList([...prepList, { ...formData, id: Date.now().toString(), checked: false }]);
        setShowModal(false); setEditItem(null); setFormData({ category: '重要文件', item: '', note: '' });
      };

      return (
        <div className="fade-in space-y-6">
          <h2 className="text-3xl font-bold serif text-[#4E342E] px-2">準備清單</h2>
          <button onClick={() => { setEditItem(null); setShowModal(true); }} className="floating-action-button"><Plus size={32} /></button>
          <div className="space-y-6 pb-10">
            {['重要文件', '電子電器', '衣物穿搭', '馬爾地夫專屬', '個人藥品', '生活用品'].map(cat => {
              const items = prepList.filter(p => p.category === cat);
              if (items.length === 0) return null;
              return (
                <div key={cat} className="space-y-3">
                  <h3 className="text-[10px] font-black text-[#A68A71] uppercase tracking-[0.2em] px-2">{cat}</h3>
                  <div className="grid gap-2">
                    {items.map(p => (
                      <div key={p.id} className="bg-white p-4 rounded-2xl border border-[#F5EBE0] flex items-center justify-between shadow-sm group">
                        <div className="flex items-center gap-4 flex-1" onClick={() => setPrepList(prepList.map(item => item.id === p.id ? {...item, checked: !item.checked} : item))}>
                          <div className={`checkbox-custom ${p.checked ? 'checked' : ''}`} />
                          <div className={p.checked ? 'opacity-40' : ''}>
                            <div className={`font-bold text-sm ${p.checked ? 'line-through' : ''}`}>{p.item}</div>
                            <div className="text-[10px] text-[#A68A71] italic">{p.note}</div>
                          </div>
                        </div>
                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button onClick={() => { setEditItem(p); setFormData(p); setShowModal(true); }} className="text-[#D8C4B6]"><Edit2 size={14} /></button>
                          <button onClick={() => setPrepList(prepList.filter(item => item.id !== p.id))} className="text-red-200"><Trash2 size={14} /></button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
          {showModal && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center px-4">
              <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setShowModal(false)} />
              <div className="relative bg-white w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-4 -translate-y-12">
                <h3 className="text-xl font-bold serif text-center">{editItem ? '編輯項目' : '新增項目'}</h3>
                <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                  {['重要文件', '電子電器', '衣物穿搭', '馬爾地夫專屬', '個人藥品', '生活用品'].map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <input type="text" value={formData.item} onChange={e => setFormData({...formData, item: e.target.value})} placeholder="例如：護照" />
                <input type="text" value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} placeholder="例如：隨身帶" />
                <div className="flex gap-3 pt-4"><button onClick={() => setShowModal(false)} className="flex-1 py-4 rounded-2xl bg-[#FDFBF7]">取消</button><button onClick={handleSave} className="flex-1 py-4 rounded-2xl bg-[#4E342E] text-white">儲存</button></div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ItineraryView({ itinerary, setItinerary }) {
      const [dayIdx, setDayIdx] = useState(0);
      const [showModal, setShowModal] = useState(false);
      const [editAct, setEditAct] = useState(null);
      const [formData, setFormData] = useState({ time: '08:00', title: '', loc: '', note: '' });
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [activityGroupIdx, setActivityGroupIdx] = useState(0);
      const [searchTerm, setSearchTerm] = useState('');
      const [showSearch, setShowSearch] = useState(false);

      const day = itinerary[dayIdx];

      const handleSave = () => {
        if (!formData.title) return;
        const newItinerary = [...itinerary];
        if (editAct) newItinerary[dayIdx].activities = newItinerary[dayIdx].activities.map(a => a.id === editAct.id ? { ...formData, id: a.id } : a);
        else newItinerary[dayIdx].activities.push({ ...formData, id: Date.now().toString() });
        newItinerary[dayIdx].activities.sort((a, b) => a.time.localeCompare(b.time));
        setItinerary(newItinerary); setShowModal(false); setEditAct(null); setFormData({ time: '08:00', title: '', loc: '', note: '' });
      };

      const currentActivityGroup = RESORT_ACTIVITY_GROUPS[activityGroupIdx];
      const filteredResortItems = currentActivityGroup.items.filter(item => 
        item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
        item.detail.toLowerCase().includes(searchTerm.toLowerCase())
      );

      return (
        <div className="fade-in space-y-6">
          <div className="flex overflow-x-auto gap-3 pb-2 no-scrollbar snap-x">
            {itinerary.map((d, i) => (
              <button key={i} onClick={() => setDayIdx(i)} className={`flex-shrink-0 w-12 h-16 rounded-2xl flex flex-col items-center justify-center border transition-all ${dayIdx === i ? 'bg-[#4E342E] text-white shadow-lg' : 'bg-white text-[#A68A71] border-[#F5EBE0]'}`}>
                <span className="text-[8px] font-black uppercase opacity-60">Jan</span><span className="text-lg font-black mt-1">{d.date.split('/')[1]}</span>
              </button>
            ))}
          </div>
          <button onClick={() => { setEditAct(null); setFormData({ time: '08:00', title: '', loc: '', note: '' }); setShowModal(true); }} className="floating-action-button"><Plus size={32} /></button>
          <div className="bg-white p-7 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm mb-6">
            <div className="mb-6"><div className="text-[10px] font-black text-[#A68A71] mb-1">Day 0{dayIdx + 1} · {day.date}</div><h2 className="text-2xl font-bold text-[#4E342E] serif leading-tight">{day.title}</h2></div>
            <div className="space-y-8 relative ml-1">
              <div className="absolute left-[17px] top-3 bottom-3 w-[1px] bg-[#F5EBE0]" />
              {day.activities.map(act => (
                <div key={act.id} className="flex gap-5 relative z-10 group">
                  <div className="w-9 h-9 rounded-xl border-2 border-[#F5EBE0] bg-white flex items-center justify-center text-[#4E342E] shrink-0"><Clock size={16} /></div>
                  <div className="flex-1">
                    <div className="flex justify-between items-start">
                      <span className="text-[10px] font-black text-[#D8C4B6]">{act.time}</span>
                      <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onClick={() => { setEditAct(act); setFormData(act); setShowModal(true); }} className="text-[#D8C4B6]"><Edit2 size={14} /></button>
                        <button onClick={() => { const ni = [...itinerary]; ni[dayIdx].activities = ni[dayIdx].activities.filter(a => a.id !== act.id); setItinerary(ni); }} className="text-red-200"><Trash2 size={14} /></button>
                      </div>
                    </div>
                    <h4 className="font-bold text-base text-[#4E342E]">{act.title}</h4>
                    {act.loc && <div className="text-[10px] text-[#A68A71] flex items-center gap-1 mt-1 font-bold"><MapPin size={10} /> {act.loc}</div>}
                    {act.note && <p className="mt-2 text-[10px] text-[#A68A71] italic bg-[#FDFBF7] p-2 rounded-lg border border-[#F5EBE0]">註：{act.note}</p>}
                  </div>
                </div>
              ))}
            </div>
          </div>
          {day.isMaldives && (
            <div className="bg-[#4E342E] p-8 rounded-[2.5rem] text-white shadow-xl mb-6">
              <div className="flex justify-between items-center mb-6">
                <div><h3 className="text-xl font-bold serif flex items-center gap-3"><Waves className="text-[#D8C4B6]" /> 度假村自費項目</h3><p className="text-[9px] text-[#D8C4B6]/60 font-black tracking-widest mt-1">{currentActivityGroup.category}</p></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowSearch(!showSearch)} className="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-[#D8C4B6]"><Search size={18} /></button>
                  <button onClick={() => { setIsRefreshing(true); setTimeout(() => { setActivityGroupIdx((activityGroupIdx + 1) % RESORT_ACTIVITY_GROUPS.length); setIsRefreshing(false); }, 600); }} className={`w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-[#D8C4B6] ${isRefreshing ? 'animate-spin' : ''}`}><RefreshCw size={18} /></button>
                </div>
              </div>
              {showSearch && <div className="mb-6 fade-in"><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="搜尋項目關鍵字..." className="w-full bg-white/5 border-white/10 text-white placeholder:text-white/20" autoFocus /></div>}
              <div className="grid gap-4">
                {filteredResortItems.map((item, i) => (
                  <div key={i} className="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <div><h4 className="font-bold text-sm text-[#D8C4B6]">{item.name}</h4><p className="text-[9px] text-white/40 mt-0.5">{item.detail}</p></div>
                    <div className="text-right"><div className="text-lg font-black text-white">${item.price}</div><div className="text-[9px] opacity-60 font-bold">≈ NT$ {(item.price * USD_TO_TWD).toLocaleString()}</div></div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {showModal && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center px-4">
              <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setShowModal(false)} />
              <div className="relative bg-white w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-4 -translate-y-12">
                <h3 className="text-xl font-bold serif text-center">{editAct ? '編輯活動' : '新增活動'}</h3>
                <div><label className="text-[10px] font-bold text-[#A68A71] ml-2 block">時間</label>
                <select value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})}>{TIME_OPTIONS.map(time => <option key={time} value={time}>{time}</option>)}</select></div>
                <input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="活動名稱" />
                <input type="text" value={formData.loc} onChange={e => setFormData({...formData, loc: e.target.value})} placeholder="地點" />
                <textarea value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} placeholder="備註..." rows="3" />
                <div className="flex gap-3 pt-4"><button onClick={() => setShowModal(false)} className="flex-1 py-4 rounded-2xl bg-[#FDFBF7]">取消</button><button onClick={handleSave} className="flex-1 py-4 rounded-2xl bg-[#4E342E] text-white">儲存</button></div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function RecommendationView() {
      const [list, setList] = useState(INITIAL_REC);
      const [selectedCity, setSelectedCity] = useState('ALL'); // ALL, KL, MV
      const [isRefreshing, setIsRefreshing] = useState(false);

      const refresh = () => {
        setIsRefreshing(true);
        setTimeout(() => {
          const shuffledList = list.map(cat => ({
            ...cat,
            items: [...cat.items].sort(() => Math.random() - 0.5)
          }));
          setList(shuffledList);
          setIsRefreshing(false);
        }, 800);
      };

      const filteredList = useMemo(() => {
        if (selectedCity === 'ALL') return list;
        return list.filter(cat => {
          if (selectedCity === 'KL') return cat.category.includes('吉隆坡');
          if (selectedCity === 'MV') return cat.category.includes('居民島');
          return true;
        });
      }, [list, selectedCity]);

      return (
        <div className="fade-in space-y-8 pb-10">
          <div className="flex justify-between items-start px-2">
            <div>
              <h2 className="text-3xl font-bold serif text-[#4E342E]">在地推薦</h2>
              <p className="text-[10px] font-black text-[#A68A71] uppercase tracking-[0.2em] mt-1">Local Recommendations</p>
            </div>
            <div className="flex flex-col items-end gap-2">
              <div className="flex gap-1.5">
                <button onClick={refresh} className={`w-10 h-10 bg-[#D8C4B6] text-white rounded-xl flex items-center justify-center shadow-md active:scale-95 transition-all ${isRefreshing ? 'animate-spin' : ''}`}><RefreshCw size={20} /></button>
              </div>
              <div className="flex bg-white/50 p-1 rounded-xl border border-[#F5EBE0] shadow-sm">
                <button onClick={() => setSelectedCity('KL')} className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all ${selectedCity === 'KL' ? 'bg-[#4E342E] text-white' : 'text-[#A68A71]'}`}>吉隆坡</button>
                <button onClick={() => setSelectedCity('MV')} className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all ${selectedCity === 'MV' ? 'bg-[#4E342E] text-white' : 'text-[#A68A71]'}`}>居民島</button>
                <button onClick={() => setSelectedCity('ALL')} className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all ${selectedCity === 'ALL' ? 'bg-[#4E342E] text-white' : 'text-[#A68A71]'}`}>全部</button>
              </div>
            </div>
          </div>
          <div className="space-y-10">
            {filteredList.map((cat, idx) => (
              <section key={idx} className="space-y-4">
                <div className="flex items-center gap-3 px-2">
                  <div className="bg-[#4E342E] text-white p-2 rounded-xl shadow-md">
                    {cat.category.includes('美食') ? <Utensils size={18} /> : (cat.category.includes('景點') || cat.category.includes('探險') ? <Camera size={18} /> : <ShoppingBag size={18} />)}
                  </div>
                  <h3 className="font-bold text-lg text-[#4E342E] serif">{cat.category}</h3>
                </div>
                <div className="grid gap-4">
                  {cat.items.map((item, i) => (
                    <div key={i} className="bg-white p-7 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm active:scale-98 transition-transform cursor-pointer group" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}`, '_blank')}>
                      <div className="flex justify-between items-start mb-2"><h4 className="font-bold text-lg text-[#4E342E] group-hover:text-[#D8C4B6] transition-colors leading-tight">{item.name}</h4><div className="flex items-center gap-1 text-[10px] font-black text-amber-500 bg-amber-50 px-2 py-1 rounded-lg"><Star size={10} fill="currentColor" /> {item.rating}</div></div>
                      <p className="text-xs text-[#A68A71] leading-relaxed mb-4">{item.desc}</p>
                      <div className="text-[10px] font-black text-[#D8C4B6] uppercase tracking-widest flex items-center gap-1">Open in Google Map <ExternalLink size={10} /></div>
                    </div>
                  ))}
                </div>
              </section>
            ))}
          </div>
        </div>
      );
    }

    function TransportView() {
      const transports = [
        { date: '01/23', id: '高鐵 0818', from: '左營', to: '桃園', time: '10:25-12:18' },
        { date: '01/23', id: 'MH 367', from: 'TPE', to: 'KUL', time: '15:10-20:05' },
        { date: '01/25', id: 'MH 485', from: 'KUL', to: 'MLE', time: '09:40-11:00' },
        { date: '01/30', id: 'MH 484', from: 'MLE', to: 'KUL', time: '12:00-19:45' },
        { date: '01/31', id: 'MH 366', from: 'KUL', to: 'TPE', time: '09:20-14:10' },
        { date: '01/31', id: '高鐵 0841', from: '桃園', to: '左營', time: '16:34-18:25' },
      ];
      return (
        <div className="fade-in space-y-6">
          <h2 className="text-3xl font-bold serif text-[#4E342E] px-2">交通資訊</h2>
          {transports.map((t, i) => (
            <div key={i} className="bg-white rounded-[2.5rem] border border-[#F5EBE0] p-7 flex justify-between items-center shadow-sm">
              <div><div className="font-black text-lg text-[#4E342E]">{t.id}</div><div className="text-[10px] text-[#A68A71] font-bold uppercase">{t.date} · {t.from} ➔ {t.to}</div></div>
              <div className="text-right font-black text-[#4E342E] text-lg">{t.time}</div>
            </div>
          ))}
        </div>
      );
    }

    function AccommodationView() {
      const hotels = [
        { nameZh: '吉隆坡孟沙假日酒店 (1/23-25)', date: '1/23-1/25', image: 'https://images.unsplash.com/photo-1520250497591-112f2f40a3f4?auto=format&fit=crop&q=80&w=800', note: '位於時尚孟沙區，頂樓泳池視野極佳，下樓即是購物商商場。' },
        { nameZh: '美居馬爾地夫渡假村 (1/25-29)', date: '1/25-1/29', image: 'https://images.unsplash.com/photo-1514282401047-d79a71a590e8?auto=format&fit=crop&q=80&w=800', note: '全包式水上別墅，位於卡夫阿里夫環礁。水下生態極其豐富。' },
        { nameZh: 'h78 居民島飯店 (1/29-30)', date: '1/29-1/30', image: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&q=80&w=800', note: '海濱首排飯店，鄰近機場，服務親切且早餐優質。' },
        { nameZh: 'Umi 質感民宿 (1/30-31)', date: '1/30-31', image: 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&q=80&w=800', note: '靠近吉隆坡機場周邊，環境清幽。' }
      ];
      return (
        <div className="fade-in space-y-8">
          <h2 className="text-3xl font-bold serif text-[#4E342E] px-2">住宿安排</h2>
          {hotels.map((h, i) => (
            <div key={i} className="bg-white rounded-[3rem] overflow-hidden shadow-sm border border-[#F5EBE0]">
              <div className="h-64 overflow-hidden relative"><img src={h.image} className="w-full h-full object-cover" /></div>
              <div className="p-8"><h3 className="text-xl font-bold text-[#4E342E] serif leading-tight">{h.nameZh}</h3><div className="text-xs text-[#A68A71] flex items-center gap-2 my-4"><Calendar size={14} /> {h.date}</div><p className="bg-[#FDFBF7] p-4 rounded-2xl border border-[#F5EBE0] text-xs italic text-[#4E342E]">{h.note}</p></div>
            </div>
          ))}
        </div>
      );
    }

    function ExpenseView({ expenses, setExpenses }) {
      const [showModal, setShowModal] = useState(false);
      const [item, setItem] = useState({ title: '', amount: '', currency: 'USD' });
      const [convVal, setConvVal] = useState('');
      const [convMode, setConvMode] = useState('USD');
      const addExpense = () => {
        if (!item.title || !item.amount) return;
        const rate = item.currency === 'USD' ? USD_TO_TWD : MYR_TO_TWD;
        setExpenses([{ ...item, id: Date.now(), twd: Math.round(parseFloat(item.amount) * rate) }, ...expenses]);
        setShowModal(false);
      };
      const totalTwd = expenses.reduce((sum, e) => sum + e.twd, 0);
      return (
        <div className="fade-in space-y-6 pb-20">
          <div className="bg-white p-7 rounded-[2.5rem] border border-[#F5EBE0] shadow-sm space-y-4">
            <h3 className="font-bold text-sm text-[#4E342E] flex items-center gap-2"><DollarSign size={16} className="text-[#D8C4B6]" /> 匯率換算</h3>
            <div className="flex bg-[#FDFBF7] p-1.5 rounded-2xl border border-[#F5EBE0]">
              {['USD', 'MYR'].map(m => <button key={m} onClick={() => setConvMode(m)} className={`flex-1 py-2 rounded-xl text-xs font-black ${convMode === m ? 'bg-[#4E342E] text-white shadow-md' : 'text-[#A68A71]'}`}>{m}</button>)}
            </div>
            <div className="text-center">
              <input type="number" value={convVal} onChange={e => setConvVal(e.target.value)} placeholder="金額" className="text-center font-black text-xl py-2 bg-transparent" />
              <div className="mt-2 text-[11px] font-black text-[#A68A71] uppercase">≈ NT$ {Math.round((parseFloat(convVal) || 0) * (convMode === 'USD' ? USD_TO_TWD : MYR_TO_TWD)).toLocaleString()}</div>
            </div>
          </div>
          <div className="bg-[#4E342E] p-8 rounded-[3rem] text-white shadow-2xl flex justify-between items-end">
            <div><p className="text-[10px] font-black opacity-50 uppercase mb-1">Total Spending</p><h2 className="text-4xl font-black">NT$ {totalTwd.toLocaleString()}</h2></div>
            <Wallet size={40} className="opacity-10" />
          </div>
          <div className="flex justify-between items-center px-2"><h2 className="text-xl font-bold serif text-[#4E342E]">支出明細</h2><button onClick={() => setShowModal(true)} className="w-10 h-10 bg-[#4E342E] text-white rounded-xl flex items-center justify-center shadow-lg"><Plus size={20} /></button></div>
          <div className="space-y-3">
            {expenses.map(e => (
              <div key={e.id} className="bg-white p-5 rounded-2xl border border-[#F5EBE0] flex justify-between items-center">
                <div><div className="font-bold text-[#4E342E] text-sm">{e.title}</div><div className="text-[10px] text-[#A68A71] font-bold uppercase">{e.currency} {e.amount}</div></div>
                <div className="text-right font-black text-[#4E342E] text-sm">NT$ {e.twd.toLocaleString()}</div>
              </div>
            ))}
          </div>
          {showModal && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center px-4">
              <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setShowModal(false)} />
              <div className="relative bg-white w-full max-sm p-8 rounded-[2.5rem] shadow-2xl space-y-4 -translate-y-12">
                <input type="text" value={item.title} onChange={e => setItem({...item, title: e.target.value})} placeholder="項目" />
                <input type="number" value={item.amount} onChange={e => setItem({...item, amount: e.target.value})} placeholder="金額" />
                <select value={item.currency} onChange={e => setItem({...item, currency: e.target.value})}><option value="USD">USD</option><option value="MYR">MYR</option></select>
                <div className="flex gap-3 pt-4"><button onClick={() => setShowModal(false)} className="flex-1 py-4 rounded-2xl bg-[#FDFBF7]">取消</button><button onClick={addExpense} className="flex-1 py-4 rounded-2xl bg-[#4E342E] text-white">儲存</button></div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>